# LearnLoop Notion 初期接続設定ガイド

本プロジェクト（LearnLoop）をNotionと連携させるための初期設定手順です。
特にSDKのバージョン（v5.9.0以降）の仕様により、通常のデータベースIDとは異なる「データソースID」が必要になる点に注意してください。

---

## 1. インテグレーション（APIキー）の取得

1. **[Notion My integrations](https://www.notion.so/my-integrations)** にアクセスします。
2. **「+ 新しいインテグレーション」** を作成します。
   - **名前**: `LearnLoop-Connector` など
   - **タイプ**: 内部インテグレーション
3. 作成後、**「内部インテグレーションシークレット」** をコピーし、`.env.local` の `NOTION_TOKEN` に貼り付けます。
4. **「Capabilities」** タブで以下が有効であることを確認してください。
   - Read content
   - Update content
   - Insert content

---

## 2. データベースの権限付与（コネクト追加）

1. 連携したいNotionのデータベースをブラウザで開きます。
2. 画面右上の **「･･･」（三点リーダー）** をクリックします。
3. **「コネクトを追加」** を選択し、手順1で作成したインテグレーション名を検索して追加します。
   - **注意**: これを行わないと、APIからデータベースを検知できず `object_not_found` エラーになります。

---

## 3. Database ID（データソースID）の取得と設定

本プロジェクトで使用しているSDK（@notionhq/client v5.9.0）では、URLから取得できるIDではアクセスできない場合があります。以下の手順で**正式な内部ID**を特定してください。

### 手順 A: URLから暫定IDを確認
ブラウザでデータベースを**フルページ**で開いた際のURLを確認します。
`https://www.notion.so/1aae3ce608a280c29f5aef3c8fee3540?v=...`
→ この `1aae3ce6...` の部分を控えます。

### 手順 B: Search APIによる正式IDの特定
URLのIDでエラーが出る場合は、データベース名（例: 「あとで読むリスト」）から逆引きします。

1. プロジェクトルートで調査用スクリプト（Search API利用）を実行し、Notion側が認識しているUUIDを特定します。
2. 取得されたハイフン付きのID（UUID形式）を `.env.local` に設定します。

**設定例 (`.env.local`)**:
```env
NOTION_TOKEN=ntn_...（取得したシークレット）
NOTION_DATABASE_ID=1aae3ce6-08a2-80c2-9a1e-000b9361b02a
```

## 4. 接続テストの実行
設定が完了したら、ドライランモードで接続を確認します。

```bash
# object_not_found が出ないことを確認
npm run batch:check:dry
```

## よくあるトラブルシューティング
- 401 Unauthorized:
  - NOTION_TOKEN が間違っているか、ワークスペースが異なります。
- 404 Object Not Found:
  - 手順2の「コネクト追加」を忘れている。
  - データベースIDに「ハイフンなしのURL ID」を使用しており、API側がUUID形式を求めている。

---

## 付録: 調査・デバッグ用スクリプト

IDが特定できない、あるいはプロパティ名が合わない場合に、プロジェクトルートに作成して実行してください。

### A. データベース名から正式IDを特定する (`scripts/search-db.ts`)

```typescript
import { Client } from '@notionhq/client';

async function main() {
  console.log('--- Notion Search API によるID特定 ---');
  const token = process.env.NOTION_TOKEN;
  if (!token) {
    console.error('NOTION_TOKEN が設定されていません。');
    return;
  }
  
  const client = new Client({ auth: token });
  
  try {
    const response = await client.search({
      query: 'あとで読むリスト', // ここを対象のデータベース名に変更
      filter: {
        value: 'data_source', // SDK v5.9.0以降は 'data_source' 指定が必要な場合があります
        property: 'object'
      },
      page_size: 5
    });
    
    console.log(`検索結果: ${response.results.length} 件`);
    
    for (const item of response.results) {
      console.log('---');
      console.log('ID (UUID):', item.id);
      console.log('タイトル:', (item as any).title?.[0]?.plain_text || '無題');
      console.log('URL:', (item as any).url);
    }
  } catch (error: any) {
    console.error('検索失敗:', error.body || error);
  }
}

main();
```

**実行コマンド**:
```bash
npx tsx --env-file=.env.local scripts/search-db.ts
```

### B. データベースのプロパティ（列名）を確認する (`scripts/inspect-db.ts`)

```typescript
import { Client } from '@notionhq/client';

async function main() {
  console.log('--- Notion データベース定義の確認 ---');
  const token = process.env.NOTION_TOKEN;
  const dbId = process.env.NOTION_DATABASE_ID;
  
  if (!token || !dbId) {
    console.error('NOTION_TOKEN または NOTION_DATABASE_ID が設定されていません。');
    return;
  }
  
  const client = new Client({ auth: token });
  
  try {
    // SDKバージョンによるメソッドの違いを吸収
    const response: any = (client as any).dataSources 
      ? await (client as any).dataSources.retrieve({ data_source_id: dbId })
      : await client.databases.retrieve({ database_id: dbId });
    
    console.log(`データベース: ${(response.title?.[0]?.plain_text) || '不明'}`);
    console.log('--- プロパティ一覧 ---');
    
    Object.keys(response.properties).forEach(key => {
      const prop = response.properties[key];
      console.log(`名前: "${key}", 種類: ${prop.type}, ID: ${prop.id}`);
    });
  } catch (error: any) {
    console.error('取得失敗:', error.body || error);
  }
}

main();
```

**実行コマンド**:
```bash
npx tsx --env-file=.env.local scripts/inspect-db.ts
```
